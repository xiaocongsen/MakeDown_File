strace 是一个强大的 Linux 命令行工具，用于跟踪进程执行时的系统调用以及接收的信号，这对于诊断和调试程序问题非常有帮助。以下是基本的使用方法和一些常见选项：

# 基本使用

## 跟踪新启动的进程

> strace ls

## 附加到现有进程

> strace -p 1234

## 常用选项

- -o 文件名：将 strace 的输出重定向tt到指定的文件而不是标准输出。
- -t：在每条系统调用前添加时间戳。
- -tt：时间戳精确到微秒。
- -T：显示每个系统调用的耗时（总耗时和系统调用内部的耗时）。
- -e expr：指定要跟踪的系统调用或事件。例如，只跟踪 open 和 read 调用：
    strace -e open,read ls
- -f：跟踪由被跟踪进程创建的子进程。
- -ff：与 -f 类似，但是为每个子进程创建单独的输出文件。
- -qq：静默模式，减少冗余信息输出，只显示错误信息。
- -c 选项可以统计每个系统调用的调用次数和所占时间百分比，有助于性能瓶颈的定位。


## 注意事项

1. 使用 strace 可能会大幅增加程序的运行时间，尤其是当启用详细跟踪或统计时。
1. 由于 strace 会干扰程序的正常执行流程，因此在生产环境中使用时需谨慎。


## 相关系统调用的介绍

faccessat: 此系统调用用于检查文件或目录是否可访问，以及是否满足指定的访问权限。它允许指定一个目录文件描述符（通过dirfd参数）和一个相对路径（通过pathname参数），这在处理符号链接和访问权限检查时提供了额外的灵活性。如果指定了AT_EACCESS标志，它会根据进程的有效用户ID和组ID来检查权限，而不是实际的ID。

openat: 与传统的open系统调用类似，但提供了更多的灵活性。通过接受一个目录文件描述符（除了文件路径名之外），openat允许程序在指定的目录上下文中打开文件，这对于处理特定目录的操作（如chroot环境）非常有用。如果dirfd是AT_FDCWD，则默认在当前工作目录下操作，类似于普通open调用。

fstat: 此调用用于获取与文件描述符相关联的文件状态信息，如文件大小、inode号、权限、链接数等。这对于程序来说非常重要，因为它可以在执行进一步的I/O操作之前了解文件的具体属性。例如，一个程序可能会先用fstat来检查文件大小，然后决定是否分配足够的缓冲区来读取文件内容。

mmap: 内存映射函数，它将文件的内容或其他对象映射到进程的虚拟内存空间中。这意味着文件的部分或全部内容可以被直接映射到进程地址空间，使得文件读写如同直接操作内存一样高效。mmap可以提高大文件操作的性能，并且支持共享内存，即多个进程可以通过映射同一个文件来共享其内容。它可以设置为读、写或执行权限，并且当映射为MAP_SHARED时，对映射内存的更改会反映回原文件。

mprotect: 该系统调用用于修改内存区域的访问权限。程序可以使用它来改变已映射内存的保护属性，比如将只读区域变为可读写，或者将可执行区域变为不可执行。这对于动态调整代码段的权限（如JIT编译后执行代码）或确保数据安全非常关键。

munmap: 与mmap相反，munmap用于取消先前通过mmap映射到进程地址空间的内存区域。这会释放那些映射占用的物理内存和虚拟内存资源，是管理内存的重要手段。

set_tid_address: 这个系统调用用于设置线程ID（TID）的存放地址。当新线程创建时，内核会将该线程的TID写入由这个调用指定的地址，常用于父进程监控子线程的状态。

set_robust_list: 用于设置“健壮的异步信号处理”链表的头。当使用POSIX线程库中的“健壮的信号处理”特性时，如果线程在处理某些信号时崩溃，内核会将相关信息写入此链表，以帮助其他线程清理资源。

rt_sigaction: 用于修改或查询与指定信号相关的处理动作。它允许程序安装自定义的信号处理器，控制信号的阻塞状态，以及信号的传递行为，是信号处理机制的核心。

rt_sigprocmask: 用来改变当前进程的信号屏蔽字，即决定哪些信号当前是被阻塞的，不会立即传递给进程。这对于在执行关键操作时避免被信号中断非常有用。

prlimit64: 控制或查询进程的资源限制，如最大文件大小、CPU时间、虚拟内存大小等。这对于实现资源管理和防止资源滥用至关重要。

brk/sbrk: 这些调用用于调整进程的堆段大小。brk用于直接设置堆结束地址，而sbrk用于基于当前堆结束地址增加或减少堆大小。它们是早期的内存分配方式，现代程序更倾向于使用mmap或malloc库。

futex: 快速用户空间锁（Fast Userspace Locking）的简称，是一种高效的线程同步机制。它允许用户态程序实现等待和唤醒操作，常用于实现轻量级锁、条件变量和其他并发原语。

statfs: 用于获取文件系统的状态信息，如总空间、可用空间、文件系统类型等。这对于程序判断磁盘空间是否足够、进行容量规划等场景非常有用。