# IPSec基本概念

    IPSec安全传输数据的前提是在IPSec对等体（即运行IPSec协议的两个端点）之间成功建立安全联盟SA（Security Association）

## 安全联盟SA

> SA是在通信双方之间建立和维护安全通信的概念。它定义了加密算法、认证算法、密钥等安全参数，并为数据包提供安全服务。
> SA由三元组标识：SPI、目的IP地址和安全协议号（AH或ESP）。
> SA是单向的逻辑连接,可以使用AH或ESP来保护数据,是双向通信 需要建立两个SA，也可同时使用AH和ESP(需要四个SA)。
> SA的建立方式有手动方式和IKE自动协商方式。在中大型网络中，推荐使用IKE自动协商方式，以降低密钥管理成本和提高安全性。

## 安全协议

    IPSec使用认证头AH（Authentication Header）和封装安全载荷ESP（Encapsulating Security Payload）两种IP传输层协议来提供认证或加密等安全服务，AH和ESP协议可以单独使用或同时使用，以根据安全需求提供合适的安全保护。

### AH协议

    AH协议提供数据来源认证和数据完整性校验，但不提供加密功能。

![AH报文结构](./AH%E6%8A%A5%E6%96%87%E7%BB%93%E6%9E%84.png)

#### AH报文头结构

1. 下一头部：指示紧随AH报文头的下一个扩展报文头的类型，或者是原始的IP数据报文的上一层协议类型。
2. 负载长度：表示AH报文头长度减2，缺省为4。 将负载长度乘以4，再加上2，以获得字节数 
3. 保留：必须设置为0。
4. 安全参数索引(SPI)：用于标识与该AH报文头关联的安全参数集合。
5. 序列号：是一个从1开始的单项递增的计数器，用于防止重放攻击，确保报文的顺序性。
6. 认证数据：该字段包含数据完整性校验值 ICV（Integrity Check Value），用于接收方进行完整性校验。可选择的认证算法有MD5、SHA1、SHA2、SM3。

### ESP协议

    ESP协议支持数据认证和加密功能，保证数据的机密性。

![ESP报文结构](./ESP%E6%8A%A5%E6%96%87%E7%BB%93%E6%9E%84.png)

#### ESP报文头结构

1. SPI：4字节字段，用于唯一标识安全关联（SA）。SPI的值由发送方和接收方在SA建立过程中协商确定。
1. 序列号：4字节字段，用于实现防重放攻击的保护机制。发送方对每个发送的ESP报文递增地设置Sequence Number的值，接收方使用该值来验证报文的顺序和重放情况。
1. 负载数据：变长字段，包含ESP报文的有效载荷数据。这部分数据是通过加密算法对原始数据进行加密后得到的结果。
1. 填充字段：变长字段，用于填充报文，以满足加密算法的要求。填充的内容可以是任意值，但在解密时会被丢弃。
1. 填充长度：1字节字段，指示Padding字段的长度。
1. 下一头部：1字节字段，指示ESP报文后面紧跟的下一个协议的类型。它可以是IP协议中的任何协议类型，例如TCP、UDP等。
1. 认证数据：变长字段，用于提供数据完整性保护。这个字段包含了对ESP报文头、Payload Data、Padding和Pad Length字段进行认证的结果。认证数据是通过安全哈希算法（如HMAC）生成的，接收方可以使用相同的算法对接收到的报文进行认证验证。

### 分装模式

    封装模式是指将AH或ESP相关的字段插入到原始IP报文中，以实现对报文的认证和加密，封装模式有传输模式和隧道模式两种。

- 传输模式

    在传输模式中，AH头或ESP头被插入到IP头与传输层协议头之间，保护TCP/UDP/ICMP负载。由于传输模式未添加额外的IP头，所以原始报文中的IP地址在加密后报文的IP头中可见。以TCP报文为例，原始报文经过传输模式封装后.

    ![AH和ESP传统模式报文封装](./AH%E5%92%8CESP%E7%9A%84%E4%BC%A0%E7%BB%9F%E6%A8%A1%E5%BC%8F%E6%8A%A5%E6%96%87%E5%B0%81%E8%A3%85.png)

    传输模式下，与AH协议相比，ESP协议的完整性验证范围不包括IP头，无法保证IP头的安全。

- 隧道模式

    在隧道模式下，AH头或ESP头被插到原始IP头之前，另外生成一个新的报文头放到AH头或ESP头之前，保护IP头和负载。以TCP报文为例，原始报文经隧道模式封装后的报文结构

    ![AH和ESP隧道模式报文封装](./AH%E5%92%8CESP%E7%9A%84%E9%9A%A7%E9%81%93%E6%A8%A1%E5%BC%8F%E6%8A%A5%E6%96%87%E5%B0%81%E8%A3%85.png)

    隧道模式下，与AH协议相比，ESP协议的完整性验证范围不包括新IP头，无法保证新IP头的安全。

#### 传输模式和隧道模式比较

    从安全性来讲，隧道模式优于传输模式。它可以完全地对原始IP数据包进行验证和加密。隧道模式下可以隐藏内部IP地址，协议类型和端口。

    从性能来讲，隧道模式因为有一个额外的IP头，所以它将比传输模式占用更多带宽。

    从场景来讲，传输模式主要应用于两台主机或一台主机和一台VPN网关之间通信；隧道模式主要应用于两台VPN网关之间或一台主机与一台VPN网关之间的通信。

    当安全协议同时采用AH和ESP时，AH和ESP协议必须采用相同的封装模式。

### 加密

    IPSec工作过程中涉及数据加密和协议消息加密两种加密情况。

#### 数据加密

    IPSec采用对称加密算法对数据进行加密和解密。对称加密算法是指数据发送方和接收方使用相同的密钥进行加密、解密。
